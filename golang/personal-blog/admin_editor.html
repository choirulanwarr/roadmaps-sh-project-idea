<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor - Blog Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style> 
        body { font-family: 'Plus Jakarta Sans', sans-serif; } 
        /* Custom Quill Style untuk menyesuaikan dengan Tailwind */
        .ql-toolbar.ql-snow { border-color: #e2e8f0 !important; border-top-left-radius: 0.75rem; border-top-right-radius: 0.75rem; background-color: #f8fafc; }
        .ql-container.ql-snow { border-color: #e2e8f0 !important; border-bottom-left-radius: 0.75rem; border-bottom-right-radius: 0.75rem; font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1.125rem; }
        .ql-editor { min-height: 300px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen py-10 px-4">

    <div class="max-w-4xl mx-auto">
        <!-- Header Navigation -->
        <div class="flex justify-between items-center mb-6">
            <a href="admin_dashboard.html" class="flex items-center text-slate-500 hover:text-slate-800 transition-colors text-sm font-medium">
                ‚Üê Batal
            </a>
            <h1 id="page-title" class="text-lg font-bold text-slate-800">Editor</h1>
            <div class="w-16"></div> 
        </div>

        <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 relative overflow-hidden">
            <!-- Loading Overlay (Initial Load) -->
            <div id="loading-overlay" class="absolute inset-0 bg-white z-10 flex items-center justify-center hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            </div>

            <form onsubmit="handleSave(event)" class="space-y-6">
                
                <!-- Title Input -->
                <div>
                    <input type="text" id="title" required class="w-full text-3xl sm:text-4xl font-bold text-slate-900 placeholder-slate-300 border-none focus:ring-0 px-0 outline-none" placeholder="Judul Artikel...">
                </div>

                <!-- Date Input -->
                <div class="flex items-center gap-3 text-slate-500 border-b border-transparent focus-within:border-slate-200 transition-colors pb-2">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    <input type="text" id="date" required class="bg-transparent text-sm font-medium w-full focus:outline-none placeholder-slate-400" placeholder="Tanggal (e.g., 12 Agustus 2024)">
                </div>

                <!-- WYSIWYG Editor Container -->
                <div>
                    <div id="editor-container" class="bg-white"></div>
                </div>

                <!-- Error Message -->
                <div id="error-msg" class="hidden text-red-500 text-sm font-medium bg-red-50 p-3 rounded-lg"></div>

                <!-- Action Bar -->
                <div class="flex justify-end pt-4 border-t border-slate-100">
                    <button type="submit" id="submit-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-semibold shadow-lg shadow-indigo-200 transition-all hover:-translate-y-0.5 disabled:opacity-70 disabled:cursor-not-allowed">
                        Publikasikan
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        const token = localStorage.getItem('admin_token');
        if (!token) window.location.href = 'login.html';

        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('id');

        // --- Inisialisasi Quill Editor ---
        var quill = new Quill('#editor-container', {
            theme: 'snow',
            placeholder: 'Tulis cerita inspiratif Anda di sini...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    ['blockquote', 'code-block'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    ['link', 'clean']
                ]
            }
        });

        // Initial Load
        if (articleId) {
            document.getElementById('page-title').innerText = "Edit Artikel";
            document.getElementById('submit-btn').innerText = "Simpan Perubahan";
            loadArticleData(articleId);
        }

        async function loadArticleData(id) {
            document.getElementById('loading-overlay').classList.remove('hidden');
            try {
                const res = await fetch(`http://localhost:8080/articles/${id}`);
                const article = await res.json();
                
                document.getElementById('title').value = article.title;
                document.getElementById('date').value = article.date;
                
                // Set konten ke Quill (HTML)
                quill.root.innerHTML = article.content;
            } catch(e) {
                alert("Gagal memuat data."); 
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        async function handleSave(e) {
            e.preventDefault();
            const btn = document.getElementById('submit-btn');
            const errorMsg = document.getElementById('error-msg');
            
            // Validasi manual karena Quill menggunakan div, bukan input standar
            if (quill.getText().trim().length === 0) {
                errorMsg.innerText = "Konten artikel tidak boleh kosong.";
                errorMsg.classList.remove('hidden');
                return;
            }

            const originalText = btn.innerText;
            btn.innerText = "Menyimpan...";
            btn.disabled = true;
            errorMsg.classList.add('hidden');

            const payload = {
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                content: quill.root.innerHTML // Ambil HTML dari Quill
            };
            
            let url = 'http://localhost:8080/articles';
            let method = 'POST';

            if (articleId) {
                url = `http://localhost:8080/articles/${articleId}`;
                method = 'PUT';
            }

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });

                if (res.ok) {
                    window.location.href = 'admin_dashboard.html';
                } else {
                    errorMsg.innerText = "Gagal menyimpan. Sesi mungkin berakhir.";
                    errorMsg.classList.remove('hidden');
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            } catch (err) {
                errorMsg.innerText = "Gagal terhubung ke server.";
                errorMsg.classList.remove('hidden');
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>